<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FES Document Compiler</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="{{ url_for('static', filename='js/sortable.min.js') }}"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
</head>
<body class="bg-light">
  <div class="container mt-5">
    <h2>üìÑ FES Document Compiler</h2>

    <form id="uploadForm" enctype="multipart/form-data">
      <input type="file" name="images[]" multiple class="form-control mb-3">
      <button type="submit" id="uploadBtn" class="btn btn-primary">
        <span id="uploadSpinner" class="spinner-border spinner-border-sm d-none me-2"></span>
        Upload & Analyze
      </button>
    </form>

    <div id="preview" class="d-flex flex-row flex-wrap gap-3 mt-4"></div>

    <button id="compileBtn" class="btn btn-success mt-4 d-none">
      <span id="compileSpinner" class="spinner-border spinner-border-sm d-none me-2"></span>
      ‚úÖ Compile PDF
    </button>
    <a id="downloadLink" href="#" target="_blank" class="btn btn-outline-primary d-none mt-2">‚¨áÔ∏è Download PDF</a>
  </div>

  <!-- Modal for Cropping -->
  <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content bg-dark">
        <div class="modal-header border-0">
          <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body d-flex flex-column align-items-center justify-content-center text-white p-0">
          <div id="cropperContainer" style="width: 100%; height: 85vh; display: flex; justify-content: center; align-items: center; background-color: #333;">
            <img id="modalImage"
                 style="max-width: 100%; max-height: 100%; display: block;"
                 src=""
                 alt="To Crop">
          </div>
          <button id="cropSaveBtn" class="btn btn-light mt-3 mb-4">Crop & Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Enlarged Image Preview Modal -->
  <div id="imagePreviewModal"
       style="display:none; opacity:0; transition: all 0.3s ease; position:fixed; z-index:9999; top:0; left:0; width:100vw; height:100vh; background-color:rgba(0,0,0,0.8); justify-content:center; align-items:center;">
    <span id="closeImagePreview"
          style="position:absolute; top:20px; right:30px; font-size:30px; color:white; cursor:pointer;">&times;</span>
    <img id="enlargedImage"
         src=""
         style="max-width:90%; max-height:90%; box-shadow:0 0 10px black;">
  </div>

  <script>
    const form = document.getElementById("uploadForm");
    const uploadBtn = document.getElementById("uploadBtn");
    const uploadSpinner = document.getElementById("uploadSpinner");
    const preview = document.getElementById("preview");
    const compileBtn = document.getElementById("compileBtn");
    const compileSpinner = document.getElementById("compileSpinner");
    const downloadLink = document.getElementById("downloadLink");
    const modalImg = document.getElementById("modalImage");
    let cropper;
    let compiledUrl = "";

    function showToast(message) {
      const toast = document.createElement("div");
      toast.className = "toast align-items-center text-white bg-primary border-0 position-fixed bottom-0 end-0 m-3 show";
      toast.role = "alert";
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>`;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.classList.remove("show");
        toast.remove();
      }, 3000);
    }

    form.onsubmit = async (e) => {
      e.preventDefault();
      preview.innerHTML = "";
      downloadLink.classList.add("d-none");
      compileBtn.classList.add("d-none");
      compiledUrl = "";

      uploadSpinner.classList.remove("d-none");
      uploadBtn.disabled = true;

      const formData = new FormData(form);
      const res = await fetch("/upload", { method: "POST", body: formData });
      const data = await res.json();

      data.forEach(item => {
        const div = document.createElement("div");
        div.className = "border p-2 text-center bg-white";
        div.style.width = "200px";
        div.dataset.id = item.filename;
        div.innerHTML = `
          <div class="position-relative">
            <img src="/static/uploads/${item.filename}" class="img-fluid mb-1 clickable-preview"/>
            <button class="btn btn-sm btn-danger position-absolute top-0 end-0 delete-btn" data-id="${item.filename}">&times;</button>
            <button class="btn btn-sm btn-warning position-absolute top-0 start-0 crop-btn" data-id="${item.filename}">‚úÇÔ∏è</button>
          </div>
          <small>${item.doc_type}</small>`;
        preview.appendChild(div);
      });

      Sortable.create(preview, {
        animation: 150,
        onEnd: () => {
          compiledUrl = "";
          showToast("Order changed. Please click Compile PDF again.");
          downloadLink.classList.add("d-none");
        }
      });

      compileBtn.classList.remove("d-none");
      uploadSpinner.classList.add("d-none");
      uploadBtn.disabled = false;
    };

    preview.addEventListener("click", async (e) => {
      const id = e.target.dataset.id;
      if (e.target.classList.contains("delete-btn")) {
        const div = e.target.closest("div[data-id]");
        preview.removeChild(div);
        await fetch(`/delete_image/${id}`, { method: "POST" });
        compiledUrl = "";
        showToast("Image removed. Please click Compile PDF again.");
        downloadLink.classList.add("d-none");
      }

      if (e.target.classList.contains("crop-btn")) {
        const src = `/static/uploads/${id}`;
        modalImg.src = src;
        modalImg.dataset.filename = id;

        modalImg.onload = () => {
          if (cropper) cropper.destroy();
        
          const modalElement = document.getElementById("imageModal");
          const modalInstance = new bootstrap.Modal(modalElement);
          modalInstance.show();
        
          setTimeout(() => {
            cropper = new Cropper(modalImg, {
              aspectRatio: NaN,
              viewMode: 1,
              autoCropArea: 1.0,
              responsive: true,
              zoomable: true,
              background: false,
              scalable: true,
              movable: true
            });
          }, 500);
        };
      }
    });

    document.getElementById("cropSaveBtn").onclick = async () => {
      const canvas = cropper.getCroppedCanvas();
      const blob = await new Promise(res => canvas.toBlob(res));
      const formData = new FormData();
      formData.append("image", blob);
      formData.append("filename", modalImg.dataset.filename);
    
      await fetch("/crop_image", { method: "POST", body: formData });
    
      const updatedImg = preview.querySelector(`img[src="/static/uploads/${modalImg.dataset.filename}"]`);
      if (updatedImg) {
        const timestamp = new Date().getTime();
        updatedImg.src = `/static/uploads/${modalImg.dataset.filename}?t=${timestamp}`;
      }

      const modalInstance = bootstrap.Modal.getInstance(document.getElementById("imageModal"));
      modalInstance.hide();
    };

    compileBtn.onclick = async () => {
      compileSpinner.classList.remove("d-none");
      compileBtn.disabled = true;
      downloadLink.classList.add("d-none");

      const ordered = [...preview.children].map(div => div.dataset.id);
      const res = await fetch("/generate_pdf", {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ordered })
      });

      const data = await res.json();
      compiledUrl = data.url;

      downloadLink.href = compiledUrl;
      downloadLink.classList.remove("d-none");

      compileSpinner.classList.add("d-none");
      compileBtn.disabled = false;
    };

    // Image preview modal logic
    document.addEventListener("click", function(e) {
      if (e.target.tagName === "IMG" && e.target.classList.contains("clickable-preview")) {
        const src = e.target.src;
        const modal = document.getElementById("imagePreviewModal");
        const enlargedImage = document.getElementById("enlargedImage");
        enlargedImage.src = src;
        modal.style.pointerEvents = "auto"; // ‚úÖ enable pointer interactions again

        modal.style.display = "flex";
        setTimeout(() => {
          modal.style.opacity = "1";
        }, 10);
      }
    });

    // Close modal on X
    document.getElementById("closeImagePreview").addEventListener("click", () => {
      const modal = document.getElementById("imagePreviewModal");
      modal.style.opacity = "0";
      setTimeout(() => {
        modal.style.display = "none";
        modal.style.pointerEvents = "auto"; // reset for next time
      }, 300);
      
    });

    // Close modal on outside click
document.getElementById("imagePreviewModal").addEventListener("click", (e) => {
  if (e.target === e.currentTarget) {
    e.currentTarget.style.opacity = "0";
    e.currentTarget.style.pointerEvents = "none"; // ‚úÖ prevent blocking
    setTimeout(() => {
      e.currentTarget.style.display = "none";
    }, 300);
  }
});


    // Close modal on Escape key
    // Close modal on Escape key
document.addEventListener("keydown", function(e) {
  if (e.key === "Escape") {
    const modal = document.getElementById("imagePreviewModal");
    if (modal.style.display === "flex") {
      modal.style.opacity = "0";
      modal.style.pointerEvents = "none"; // ‚úÖ prevent blocking
      setTimeout(() => {
        modal.style.display = "none";
      }, 300);
    }
  }
});

  </script>
</body>
</html>
